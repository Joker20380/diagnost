{% extends 'diagnost/base.html' %}
{% load static i18n %}

{% block description %}{% trans "Contact information page – AI-powered car diagnostics" %}{% endblock %}
{% block title %}{% trans "Contacts" %}{% endblock %}

{% block content %}
    <div class="top-shadow"></div>
    <div class="inner-page">
      <div class="slider-item" style="background-image: url('{% static 'images/industrial_hero_3.jpg' %}');">
        <div class="container">
          <div class="row slider-text align-items-center justify-content-center">
            <div class="col-md-8 text-center col-sm-12 element-animate pt-5">
              <h1 class="pt-5"><span>{% trans "Contacts" %}</span></h1>
              <p class="mb-5 w-75">{% trans "Please feel free to contact us" %}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact Form -->
    <section class="section">
      <div class="container">
        <div class="row">
          <div class="col-md-6 mb-5 order-2">
            <form method="post" id="contact_form">
              {% csrf_token %}

              <div class="row">
                <div class="col-md-6 form-group">
                  <label for="name">{% trans "Name" %}</label>
                  <input type="text"
                         id="contact_form_name"
                         name="name"
                         class="form-control"
                         placeholder="{% trans 'Your name' %}"
                         required>
                </div>
                <div class="col-md-6 form-group">
                  <label for="phone">{% trans "Phone" %}</label>
                  <input type="tel"
                         id="contact_form_phone"
                         name="phone"
                         class="form-control"
                         placeholder="{% trans 'Your phone number' %}">
                </div>
              </div>

              <div class="row">
                <div class="col-md-12 form-group"></div>
              </div>

              <div class="row">
                <div class="col-md-12 form-group">
                  <label for="email">{% trans "Email" %}</label>
                  <input type="email"
                         id="contact_form_email"
                         name="email"
                         class="form-control"
                         placeholder="{% trans 'Your email' %}"
                         required>
                </div>
              </div>

              <div class="contact_form_text mt-3">
                <select id="contact_form_contact"
                        name="contact"
                        class="form-control"
                        style="width: 100%;">
                  <option value="">{% trans "Select recipient (optional)" %}</option>

                  {% if main_contact %}
                    <option value="{{ main_contact.id }}">
                      {% trans "Main contact" %} ({{ main_contact.name }})
                    </option>
                  {% endif %}

                  {% for group in contact_groups %}
                    {% for contact in group.contacts.all %}
                      <option value="{{ contact.id }}">
                        {{ group.name }}: {{ contact.name }}
                      </option>
                    {% endfor %}
                  {% endfor %}
                </select>
              </div>

              <div class="row">
                <div class="col-md-12 form-group">
                  <label for="message">{% trans "Message" %}</label>
                  <textarea id="contact_form_message"
                            name="message"
                            class="form-control"
                            rows="4"
                            placeholder="{% trans 'Your message' %}"
                            required></textarea>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 form-group">
                  <input type="submit"
                         value="{% trans 'Send message' %}"
                         class="btn btn-primary px-3 py-3">
                </div>
              </div>
            </form>
          </div>

          {% if main_contact %}
            <div class="col-md-6 order-2 mb-5">
              <div class="row justify-content-right">
                <div class="col-md-8 mx-auto contact-form-contact-info">

                  {% if main_contact.address %}
                    <p class="d-flex">
                      <span class="ion-ios-location icon mr-5"></span>
                      <span>{{ main_contact.address }}</span>
                    </p>
                  {% endif %}

                  {% if main_contact.phone %}
                    <p class="d-flex">
                      <span class="ion-ios-telephone icon mr-5"></span>
                      <span>{{ main_contact.phone }}</span>
                    </p>
                  {% endif %}

                  {% if main_contact.email %}
                    <p class="d-flex">
                      <span class="ion-android-mail icon mr-5"></span>
                      <span>{{ main_contact.email }}</span>
                    </p>
                  {% endif %}

                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Map -->
    <div class="contact_map">
      <div class="map_container">

      </div>
    </div>

    {% if location_lat and location_lon %}
      <script>
        const map = L.map('geomap').setView([{{ location_lat }}, {{ location_lon }}], 18);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap'
        }).addTo(map);

        const gifIcon = L.icon({
          iconUrl: "{% static 'onetech/images/logo_map.gif' %}",
          iconSize: [40, 40],
          iconAnchor: [20, 40],
          popupAnchor: [0, -40]
        });

        L.marker([{{ location_lat }}, {{ location_lon }}], { icon: gifIcon })
          .addTo(map)
          .bindPopup(`
            <div style="
              background: linear-gradient(135deg, #f8f9fa, #e9ecef);
              padding: 12px;
              border-radius: 12px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.1);
              max-width: 260px;
              font-family: sans-serif;
            ">
              <div style="display: flex; align-items: center; gap: 12px;">
                <img src="{% static 'images/logo_autozvuk.webp' %}"
                     alt="{% trans 'Contact' %}"
                     style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                <div>
                  <strong style="font-size: 1.1em;">{{ location_name|escapejs }}</strong><br>
                  <span style="font-size: 0.9em; color: #555;">{% trans "Car service" %}</span>
                </div>
              </div>
              <div style="margin-top: 10px; font-size: 0.9em; color: #333;">
                {% trans "Welcome! We are here to help." %}
              </div>
              <a href="{% url 'index' %}"
                 style="
                   display: inline-block;
                   margin-top: 10px;
                   padding: 6px 12px;
                   background: #007bff;
                   color: #fff;
                   border-radius: 6px;
                   text-decoration: none;
                   font-size: 0.9em;
                 ">
                {% trans "Learn more" %}
              </a>
            </div>
          `)
          .openPopup();
      </script>
    {% else %}
      <script>
        document.getElementById('geomap').innerHTML =
          '<p style="padding: 2em; text-align: center;">{% trans "Location is not configured yet" %}</p>';
      </script>
    {% endif %}

    <script>
      document.getElementById('contact_form').addEventListener('submit', function(e) {
        const form = e.target;
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
          if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
          } else {
            field.classList.remove('is-invalid');
          }
        });

        if (!isValid) {
          e.preventDefault();
          e.stopPropagation();
          alert("{% trans 'Please fill in all required fields' %}");
        }

        form.classList.add('was-validated');
      });
    </script>

{% endblock content %}
